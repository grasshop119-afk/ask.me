<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–µ–π—Ç–∏–Ω–≥ ‚Äî –ß–∏–±–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            border-bottom: 0.5px solid #222;
        }

        .logo {
            height: 32px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-container {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 14px;
            border: 1.5px solid var(--accent-color, #007AFF);
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .user-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .avatar-gif {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 30px;
            height: 30px;
            z-index: 2;
            pointer-events: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .main-content {
            position: absolute;
            top: 52px;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-section {
            flex-shrink: 0;
            padding: 30px 0 0 0;
            background: #000;
            position: relative;
            z-index: 10;
        }

        .sticker-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .sticker-wrapper {
            width: 150px;
            height: 150px;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 20px;
            text-align: center;
        }

        .divider {
            width: 90%;
            height: 1px;
            background: #333;
            margin: 0 auto 20px auto;
        }

        .selector-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 25px;
            align-items: center;
        }

        .selector-item {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.3s ease;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .selector-item.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .selector-icon {
            width: 24px;
            height: 24px;
        }

        .selector-label {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .rating-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }

        .rating-scroll-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 16px 20px 16px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .rating-scroll-area::-webkit-scrollbar {
            display: none;
        }

        .rating-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .rating-card {
            background: #1A1A1A;
            border-radius: 27px;
            border: 1px solid #222;
            padding: 14px;
            display: flex;
            align-items: center;
            transition: background-color 0.15s ease;
            position: relative;
        }

        .rating-card:active {
            background: #222;
        }

        .position {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            width: 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .user-avatar-small {
            width: 44px;
            height: 44px;
            border-radius: 16px;
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
            background: var(--accent-color, #007AFF);
        }

        .user-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-initial {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            text-transform: uppercase;
        }

        .user-info {
            flex: 1;
            text-align: left;
            min-width: 0;
        }

        .username {
            font-size: 16px;
            font-weight: 500;
            color: #FFFFFF;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-id {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .score {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: rgba(255, 255, 255, 0.7);
            gap: 10px;
        }

        .loading-wheel {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: rgba(255, 255, 255, 0.8);
            animation: spin 0.8s linear infinite;
        }

        .event-tooltip {
            position: absolute;
            top: 45px;
            right: -5px;
            background: #1A1A1A;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            color: #FFFFFF;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .event-tooltip.show {
            opacity: 1;
        }

        .event-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #1A1A1A;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 375px) {
            .rating-card {
                border-radius: 24px;
            }
            
            .user-avatar-small {
                border-radius: 14px;
            }
            
            .user-avatar-container {
                width: 38px;
                height: 38px;
                border-radius: 12px;
            }
            
            .avatar-gif {
                width: 26px;
                height: 26px;
                bottom: -7px;
                right: -7px;
            }
            
            .selector-container {
                gap: 30px;
            }
        }

        @media (max-width: 320px) {
            .rating-card {
                border-radius: 21px;
            }
            
            .user-avatar-small {
                border-radius: 12px;
            }
            
            .user-avatar-container {
                width: 36px;
                height: 36px;
                border-radius: 10px;
            }
            
            .avatar-gif {
                width: 24px;
                height: 24px;
                bottom: -6px;
                right: -6px;
            }
            
            .selector-container {
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header" id="header">
        <img src="https://i.ibb.co/zTB331HR/image.png" alt="Chibeki" class="logo">
        <div class="header-right">
            <div class="user-avatar-container" id="userAvatarContainer">
                <div class="user-avatar" id="userAvatar"></div>
                <img src="" alt="" class="avatar-gif" id="avatarGif">
            </div>
            <div class="event-tooltip" id="eventTooltip">NewYear2026</div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-section">
            <div class="sticker-container">
                <div class="sticker-wrapper" id="stickerContainer"></div>
            </div>
            
            <div class="title">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</div>
            
            <div class="divider"></div>
            
            <div class="selector-container" id="selectorContainer">
                <div class="selector-item active" data-type="coins">
                    <div class="selector-icon" id="coinsIcon"></div>
                    <div class="selector-label">–ö–æ–∏–Ω—ã</div>
                </div>
                <div class="selector-item" data-type="chibis">
                    <div class="selector-icon" id="chibisIcon"></div>
                    <div class="selector-label">–ß–∏–±–∏–∫–∏</div>
                </div>
            </div>
        </div>
        
        <div class="rating-container">
            <div class="rating-scroll-area" id="ratingScrollArea">
                <div class="rating-list" id="ratingList">
                    <div class="loading">
                        <div class="loading-wheel"></div>
                        <div>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let currentUserGif = '';
        let tooltipVisible = false;
        let currentRatingType = 'coins';
        let coinsData = [];
        let chibisData = [];
        let userDataMap = new Map(); // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Firebase
        let firestoreInitialized = false;
        
        // –°–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
        const EXCLUDED_USERS = ['ya_admin7', 'tmkazavr'];
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDrvqEb5GMrWaCLSd3aHEdOQIDA321v_BA",
            authDomain: "chibeki-ideas.firebaseapp.com",
            projectId: "chibeki-ideas",
            storageBucket: "chibeki-ideas.firebasestorage.app",
            messagingSenderId: "31211023786",
            appId: "1:31211023786:web:35343c74dbf73a50f6cfd3"
        };

        function initTelegramApp() {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
            
            if (tg.themeParams.accent_text_color) {
                document.documentElement.style.setProperty('--accent-color', tg.themeParams.accent_text_color);
            }
            
            tg.BackButton.onClick(goBack);
            
            document.addEventListener('click', function(e) {
                const tooltip = document.getElementById('eventTooltip');
                const avatarContainer = document.getElementById('userAvatarContainer');
                
                if (!avatarContainer.contains(e.target) && !tooltip.contains(e.target) && tooltipVisible) {
                    hideEventTooltip();
                }
            });
            
            initializeFirebase();
            setupUserAvatar();
            loadStickers();
            setupSelector();
        }

        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                firestoreInitialized = true;
                console.log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                loadAllRatingData();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
                // –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
                loadAllRatingData();
            }
        }

        async function loadUserDataFromFirestore(userId) {
            if (!firestoreInitialized) return null;
            
            try {
                const db = firebase.firestore();
                const userDoc = await db.collection('users').doc(userId.toString()).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userDataMap.set(userId, userData);
                    return userData;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore:', error);
            }
            return null;
        }

        async function loadAllUserDataFromFirestore(userIds) {
            if (!firestoreInitialized) return;
            
            try {
                const db = firebase.firestore();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ä–∞–∑—É
                const usersRef = db.collection('users');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö userIds
                const promises = userIds.map(userId => 
                    usersRef.doc(userId.toString()).get()
                );
                
                const snapshots = await Promise.all(promises);
                
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists) {
                        userDataMap.set(userIds[index], snapshot.data());
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Firestore:', error);
            }
        }

        function setupUserAvatar() {
            const user = tg.initDataUnsafe?.user;
            const avatarElement = document.getElementById('userAvatar');
            const gifElement = document.getElementById('avatarGif');
            const avatarContainer = document.getElementById('userAvatarContainer');
            
            if (user) {
                // –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ Telegram
                if (user.photo_url) {
                    avatarElement.innerHTML = `<img src="${user.photo_url}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
                } else {
                    const initial = user.username ? user.username[0].toUpperCase() : 'U';
                    avatarElement.innerHTML = `<div class="avatar-initial" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; font-weight: 700;">${initial}</div>`;
                }
                
                const username = user.username || '';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore
                if (firestoreInitialized && user.id) {
                    loadUserDataFromFirestore(user.id).then(userData => {
                        if (userData) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ Firestore, –µ—Å–ª–∏ –µ—Å—Ç—å
                            if (userData.photo_url) {
                                avatarElement.innerHTML = `<img src="${userData.photo_url}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–∏—Ñ–∫—É –∏–∑ Firestore, –µ—Å–ª–∏ –µ—Å—Ç—å
                            if (userData.reward_gif) {
                                currentUserGif = userData.reward_gif;
                                gifElement.src = currentUserGif;
                            }
                        }
                    });
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –≥–∏—Ñ–∫—É
                gifElement.src = currentUserGif || 'https://stickers.fullyst.com/0f72a8b7-c353-5e21-9e25-cbaa1f8b8a68/full/AgAD4SIAAm86EEk.webp';
                
                avatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
                
                gifElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
            } else {
                avatarElement.innerHTML = `<img src="https://img.icons8.com/?size=100&id=83180&format=png&color=000000" alt="User" style="filter: invert(1) opacity(0.7); width:20px;height:20px;">`;
                currentUserGif = 'https://stickers.fullyst.com/0f72a8b7-c353-5e21-9e25-cbaa1f8b8a68/full/AgAD4SIAAm86EEk.webp';
                gifElement.src = currentUserGif;
                
                avatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
                
                gifElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
            }
        }

        function toggleEventTooltip() {
            const tooltip = document.getElementById('eventTooltip');
            
            if (tooltipVisible) {
                hideEventTooltip();
            } else {
                tooltip.classList.add('show');
                tooltipVisible = true;
                
                setTimeout(() => {
                    hideEventTooltip();
                }, 3000);
            }
        }

        function hideEventTooltip() {
            const tooltip = document.getElementById('eventTooltip');
            tooltip.classList.remove('show');
            tooltipVisible = false;
        }

        function loadStickers() {
            fetch('Stickers/Rate.json')
                .then(response => {
                    if (!response.ok) throw new Error('Rate.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return response.json();
                })
                .then(data => {
                    lottie.loadAnimation({
                        container: document.getElementById('stickerContainer'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                })
                .catch(error => {
                    document.getElementById('stickerContainer').innerHTML = 
                        '<div style="color:white;text-align:center;padding:20px;">‚ú®</div>';
                });
            
            fetch('Stickers/coins.json')
                .then(response => {
                    if (!response.ok) throw new Error('coins.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return response.json();
                })
                .then(data => {
                    lottie.loadAnimation({
                        container: document.getElementById('coinsIcon'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                })
                .catch(error => {
                    document.getElementById('coinsIcon').innerHTML = 'üí∞';
                });
            
            fetch('Stickers/gamepad.json')
                .then(response => {
                    if (!response.ok) throw new Error('gamepad.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return response.json();
                })
                .then(data => {
                    lottie.loadAnimation({
                        container: document.getElementById('chibisIcon'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                })
                .catch(error => {
                    document.getElementById('chibisIcon').innerHTML = 'üéÆ';
                });
        }

        function setupSelector() {
            const selectorItems = document.querySelectorAll('.selector-item');
            selectorItems.forEach(item => {
                item.addEventListener('click', function() {
                    const type = this.dataset.type;
                    
                    if (currentRatingType !== type) {
                        tg.HapticFeedback.impactOccurred('light');
                        
                        selectorItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        currentRatingType = type;
                        
                        renderCurrentRating();
                    }
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function filterExcludedUsers(users) {
            return users.filter(user => {
                const username = user.username ? user.username.toLowerCase() : '';
                return !EXCLUDED_USERS.includes(username);
            });
        }

        async function loadAllRatingData() {
            try {
                await Promise.all([
                    loadCoinsRating(),
                    loadChibisRating()
                ]);
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ userIds –∏–∑ –æ–±–æ–∏—Ö —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
                const allUserIds = new Set();
                [...coinsData, ...chibisData].forEach(user => {
                    if (user.id) allUserIds.add(user.id);
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Firestore
                if (firestoreInitialized && allUserIds.size > 0) {
                    await loadAllUserDataFromFirestore(Array.from(allUserIds));
                }
                
                renderCurrentRating();
            } catch (error) {
                document.getElementById('ratingList').innerHTML = 
                    '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
            }
        }

        async function loadCoinsRating() {
            try {
                const response = await fetch('https://chibi-bot-3d4x.onrender.com/get_coins_rating');
                
                if (response.ok) {
                    let data = await response.json();
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    coinsData = filterExcludedUsers(data);
                } else {
                    coinsData = [];
                }
            } catch (error) {
                coinsData = [];
            }
        }

        async function loadChibisRating() {
            try {
                const response = await fetch('https://chibi-bot-3d4x.onrender.com/get_chibis_rating');
                
                if (response.ok) {
                    let data = await response.json();
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    chibisData = filterExcludedUsers(data);
                } else {
                    chibisData = [];
                }
            } catch (error) {
                chibisData = [];
            }
        }

        function renderCurrentRating() {
            const ratingList = document.getElementById('ratingList');
            
            if (currentRatingType === 'coins') {
                renderRating(coinsData, currentRatingType);
            } else {
                renderRating(chibisData, currentRatingType);
            }
        }

        function renderRating(players, type) {
            const ratingList = document.getElementById('ratingList');
            
            if (!players || players.length === 0) {
                ratingList.innerHTML = '<div class="empty-state">–†–µ–π—Ç–∏–Ω–≥ –ø–æ–∫–∞ –ø—É—Å—Ç</div>';
                return;
            }
            
            ratingList.innerHTML = '';
            
            players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'rating-card';
                
                const username = player.username ? `@${player.username}` : '–±–µ–∑ —é–∑–µ—Ä–Ω–µ–π–º–∞';
                const score = type === 'coins' ? player.coins || 0 : player.chibis_count || 0;
                const scoreIcon = type === 'coins' ? 'üí∞' : '‚ö°Ô∏è';
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore
                const userFirestoreData = player.id ? userDataMap.get(player.id) : null;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –∞–≤–∞—Ç–∞—Ä–µ
                let avatarContent = '';
                let avatarUrl = null;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞:
                // 1. –ê–≤–∞—Ç–∞—Ä –∏–∑ Firestore
                // 2. –ê–≤–∞—Ç–∞—Ä –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–∞
                // 3. –ò–Ω–∏—Ü–∏–∞–ª—ã
                if (userFirestoreData && userFirestoreData.photo_url) {
                    avatarUrl = userFirestoreData.photo_url;
                } else if (player.photo_url) {
                    avatarUrl = player.photo_url;
                }
                
                if (avatarUrl) {
                    avatarContent = `<img src="${avatarUrl}" alt="${player.name}" onerror="this.parentElement.innerHTML='<div class=\\'avatar-initial\\'>${player.name ? player.name[0].toUpperCase() : '?'}</div>'">`;
                } else {
                    const initial = player.name ? player.name[0].toUpperCase() : 
                                   player.username ? player.username[0].toUpperCase() : '?';
                    avatarContent = `<div class="avatar-initial">${initial}</div>`;
                }
                
                card.innerHTML = `
                    <div class="position">${index + 1}.</div>
                    <div class="user-avatar-small">
                        ${avatarContent}
                    </div>
                    <div class="user-info">
                        <div class="username">${player.name || '–ò–≥—Ä–æ–∫'}</div>
                        <div class="user-id">${username}</div>
                    </div>
                    <div class="score">
                        ${scoreIcon} ${score.toLocaleString()}
                    </div>
                `;
                
                ratingList.appendChild(card);
            });
        }

        function goBack() {
            tg.HapticFeedback.impactOccurred('light');
            
            if (window.history.length > 1) {
                window.history.back();
            } else {
                tg.close();
            }
        }

        document.addEventListener('DOMContentLoaded', initTelegramApp);
    </script>
</body>
</html>
