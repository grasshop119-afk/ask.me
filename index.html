<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–µ–π—Ç–∏–Ω–≥ ‚Äî –ß–∏–±–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            border-bottom: 0.5px solid #222;
        }

        .logo {
            height: 32px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-container {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 14px;
            border: 1.5px solid var(--accent-color, #007AFF);
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .user-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .avatar-gif {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 30px;
            height: 30px;
            z-index: 2;
            pointer-events: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .main-content {
            position: absolute;
            top: 52px;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-section {
            flex-shrink: 0;
            padding-top: 20px;
        }

        .sticker-container {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .sticker-wrapper {
            width: 120px;
            height: 120px;
        }

        .title {
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 15px;
            text-align: center;
        }

        .divider {
            width: 90%;
            height: 1px;
            background: #333;
            margin: 0 auto 15px auto;
        }

        .selector-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 15px;
            align-items: center;
            padding: 0 16px;
        }

        .selector-item {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.5;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 20px;
            position: relative;
        }

        .selector-item.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .selector-icon {
            width: 22px;
            height: 22px;
        }

        .selector-label {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .rating-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px 20px;
            position: relative;
        }

        .rating-container::-webkit-scrollbar {
            width: 4px;
            background: transparent;
        }

        .rating-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .rating-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .rating-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto;
            min-height: min-content;
        }

        .rating-card {
            background: #1A1A1A;
            border-radius: 20px;
            border: 1px solid #222;
            padding: 12px;
            display: flex;
            align-items: center;
            transition: all 0.15s ease;
            position: relative;
        }

        .rating-card:active {
            background: #222;
        }

        .rating-card.current-user {
            border-color: var(--accent-color, #007AFF);
            border-width: 1.5px;
        }

        .position {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }

        .user-avatar-small {
            width: 44px;
            height: 44px;
            border-radius: 13px;
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        .user-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            background: var(--accent-color, #007AFF);
            border-radius: 13px;
        }

        .user-info {
            flex: 1;
            text-align: left;
            min-width: 0;
            overflow: hidden;
        }

        .username {
            font-size: 16px;
            font-weight: 500;
            color: #FFFFFF;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-id {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .score {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            padding-left: 10px;
        }

        .score-icon {
            font-size: 18px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: rgba(255, 255, 255, 0.7);
            gap: 10px;
        }

        .loading-wheel {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: rgba(255, 255, 255, 0.8);
            animation: spin 0.8s linear infinite;
        }

        .event-tooltip {
            position: absolute;
            top: 45px;
            right: -5px;
            background: #1A1A1A;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            color: #FFFFFF;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .event-tooltip.show {
            opacity: 1;
        }

        .event-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #1A1A1A;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 375px) {
            .sticker-wrapper {
                width: 100px;
                height: 100px;
            }
            
            .user-avatar-container {
                width: 38px;
                height: 38px;
                border-radius: 12px;
            }
            
            .avatar-gif {
                width: 26px;
                height: 26px;
                bottom: -7px;
                right: -7px;
            }
            
            .selector-container {
                gap: 30px;
            }
            
            .rating-card {
                padding: 10px;
            }
        }

        @media (max-width: 320px) {
            .sticker-wrapper {
                width: 90px;
                height: 90px;
            }
            
            .user-avatar-container {
                width: 36px;
                height: 36px;
                border-radius: 10px;
            }
            
            .avatar-gif {
                width: 24px;
                height: 24px;
                bottom: -6px;
                right: -6px;
            }
            
            .selector-container {
                gap: 20px;
            }
            
            .rating-card {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header" id="header">
        <img src="https://i.ibb.co/zTB331HR/image.png" alt="Chibeki" class="logo">
        <div class="header-right">
            <div class="user-avatar-container" id="userAvatarContainer">
                <div class="user-avatar" id="userAvatar"></div>
                <img src="" alt="" class="avatar-gif" id="avatarGif">
            </div>
            <div class="event-tooltip" id="eventTooltip">NewYear2026</div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-section">
            <div class="sticker-container">
                <div class="sticker-wrapper" id="stickerContainer"></div>
            </div>
            
            <div class="title">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</div>
            
            <div class="divider"></div>
            
            <div class="selector-container" id="selectorContainer">
                <div class="selector-item active" data-type="coins">
                    <div class="selector-icon" id="coinsIcon"></div>
                    <div class="selector-label">–ö–æ–∏–Ω—ã</div>
                </div>
                <div class="selector-item" data-type="chibis">
                    <div class="selector-icon" id="chibisIcon"></div>
                    <div class="selector-label">–ß–∏–±–∏–∫–∏</div>
                </div>
            </div>
        </div>
        
        <div class="rating-container" id="ratingContainer">
            <div class="rating-list" id="ratingList">
                <div class="loading">
                    <div class="loading-wheel"></div>
                    <div>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let currentUserGif = '';
        let tooltipVisible = false;
        let currentRatingType = 'coins';
        let coinsData = [];
        let chibisData = [];
        let currentUserId = null;

        // –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
        const HIDDEN_USERS = ['ya_admin7', 'tmkazavr'];

        function initTelegramApp() {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
            
            if (tg.themeParams.accent_text_color) {
                document.documentElement.style.setProperty('--accent-color', tg.themeParams.accent_text_color);
            }
            
            const user = tg.initDataUnsafe?.user;
            if (user) {
                currentUserId = user.id;
            }
            
            tg.BackButton.onClick(goBack);
            
            document.addEventListener('click', function(e) {
                const tooltip = document.getElementById('eventTooltip');
                const avatarContainer = document.getElementById('userAvatarContainer');
                
                if (!avatarContainer.contains(e.target) && !tooltip.contains(e.target) && tooltipVisible) {
                    hideEventTooltip();
                }
            });
            
            setupUserAvatar();
            loadStickers();
            setupSelector();
            loadAllRatingData();
        }

        function setupUserAvatar() {
            const user = tg.initDataUnsafe?.user;
            const avatarElement = document.getElementById('userAvatar');
            const gifElement = document.getElementById('avatarGif');
            const avatarContainer = document.getElementById('userAvatarContainer');
            
            if (user) {
                if (user.photo_url) {
                    avatarElement.innerHTML = `<img src="${user.photo_url}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
                } else {
                    const initial = user.username ? user.username[0].toUpperCase() : 'U';
                    avatarElement.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:600;color:#fff;border-radius:12px;">${initial}</div>`;
                }
                
                const username = user.username || '';
                
                if (username.toLowerCase() === 'temkazavr') {
                    currentUserGif = 'https://stickers.fullyst.com/e7e72911-670d-5946-93e4-3a32dfc3bdbd/full/AgADpWUAAhchkEo.webp';
                } else if (username.toLowerCase() === 'ribapibaa') {
                    currentUserGif = 'https://telepot.ru/images/stickers_img/652a5ce136.gif';
                } else {
                    currentUserGif = 'https://stickers.fullyst.com/0f72a8b7-c353-5e21-9e25-cbaa1f8b8a68/full/AgAD4SIAAm86EEk.webp';
                }
                
                gifElement.src = currentUserGif;
                
                avatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
                
                gifElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
            } else {
                avatarElement.innerHTML = `<img src="https://img.icons8.com/?size=100&id=83180&format=png&color=000000" alt="User" style="filter: invert(1) opacity(0.7); width:20px;height:20px;">`;
                currentUserGif = 'https://stickers.fullyst.com/0f72a8b7-c353-5e21-9e25-cbaa1f8b8a68/full/AgAD4SIAAm86EEk.webp';
                gifElement.src = currentUserGif;
                
                avatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
                
                gifElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEventTooltip();
                });
            }
        }

        function toggleEventTooltip() {
            const tooltip = document.getElementById('eventTooltip');
            
            if (tooltipVisible) {
                hideEventTooltip();
            } else {
                tooltip.classList.add('show');
                tooltipVisible = true;
                
                setTimeout(() => {
                    hideEventTooltip();
                }, 3000);
            }
        }

        function hideEventTooltip() {
            const tooltip = document.getElementById('eventTooltip');
            tooltip.classList.remove('show');
            tooltipVisible = false;
        }

        function loadStickers() {
            fetch('Stickers/Rate.json')
                .then(response => {
                    if (!response.ok) throw new Error('Rate.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return response.json();
                })
                .then(data => {
                    lottie.loadAnimation({
                        container: document.getElementById('stickerContainer'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                })
                .catch(error => {
                    document.getElementById('stickerContainer').innerHTML = 
                        '<div style="color:white;text-align:center;padding:20px;">‚ú®</div>';
                });
            
            fetch('Stickers/coins.json')
                .then(response => {
                    if (!response.ok) throw new Error('coins.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return response.json();
                })
                .then(data => {
                    lottie.loadAnimation({
                        container: document.getElementById('coinsIcon'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                })
                .catch(error => {
                    document.getElementById('coinsIcon').innerHTML = 'üí∞';
                });
            
            fetch('Stickers/gamepad.json')
                .then(response => {
                    if (!response.ok) throw new Error('gamepad.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return response.json();
                })
                .then(data => {
                    lottie.loadAnimation({
                        container: document.getElementById('chibisIcon'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                })
                .catch(error => {
                    document.getElementById('chibisIcon').innerHTML = '‚ö°Ô∏è';
                });
        }

        function setupSelector() {
            const selectorItems = document.querySelectorAll('.selector-item');
            selectorItems.forEach(item => {
                item.addEventListener('click', function() {
                    const type = this.dataset.type;
                    
                    if (currentRatingType !== type) {
                        tg.HapticFeedback.impactOccurred('light');
                        
                        selectorItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        currentRatingType = type;
                        
                        renderCurrentRating();
                    }
                });
            });
        }

        async function loadAllRatingData() {
            try {
                await Promise.all([
                    loadCoinsRating(),
                    loadChibisRating()
                ]);
                
                renderCurrentRating();
            } catch (error) {
                document.getElementById('ratingList').innerHTML = 
                    '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
            }
        }

        async function loadCoinsRating() {
            try {
                const response = await fetch('https://chibi-bot-3d4x.onrender.com/get_coins_rating');
                
                if (response.ok) {
                    const data = await response.json();
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    coinsData = data.filter(player => {
                        const username = player.username || '';
                        return !HIDDEN_USERS.includes(username.toLowerCase());
                    });
                } else {
                    coinsData = [];
                }
            } catch (error) {
                coinsData = [];
            }
        }

        async function loadChibisRating() {
            try {
                const response = await fetch('https://chibi-bot-3d4x.onrender.com/get_chibis_rating');
                
                if (response.ok) {
                    const data = await response.json();
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    chibisData = data.filter(player => {
                        const username = player.username || '';
                        return !HIDDEN_USERS.includes(username.toLowerCase());
                    });
                } else {
                    chibisData = [];
                }
            } catch (error) {
                chibisData = [];
            }
        }

        function renderCurrentRating() {
            const ratingList = document.getElementById('ratingList');
            
            if (currentRatingType === 'coins') {
                renderRating(coinsData, currentRatingType);
            } else {
                renderRating(chibisData, currentRatingType);
            }
        }

        function renderRating(players, type) {
            const ratingList = document.getElementById('ratingList');
            
            if (!players || players.length === 0) {
                ratingList.innerHTML = '<div class="empty-state">–†–µ–π—Ç–∏–Ω–≥ –ø–æ–∫–∞ –ø—É—Å—Ç</div>';
                return;
            }
            
            ratingList.innerHTML = '';
            
            players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'rating-card';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                if (currentUserId && player.user_id && parseInt(player.user_id) === parseInt(currentUserId)) {
                    card.classList.add('current-user');
                }
                
                // –°–æ–∑–¥–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
                let avatarHtml = '';
                if (player.photo_url) {
                    avatarHtml = `<img src="${player.photo_url}" alt="${player.name || '–ò–≥—Ä–æ–∫'}">`;
                } else {
                    const initial = player.name ? player.name[0].toUpperCase() : '?';
                    avatarHtml = `<div class="avatar-placeholder">${initial}</div>`;
                }
                
                const username = player.username ? `@${player.username}` : '–±–µ–∑ —é–∑–µ—Ä–Ω–µ–π–º–∞';
                const score = type === 'coins' ? (player.coins || 0) : (player.chibis_count || 0);
                const scoreIcon = type === 'coins' ? 'üí∞' : '‚ö°Ô∏è';
                
                card.innerHTML = `
                    <div class="position">${index + 1}.</div>
                    <div class="user-avatar-small">
                        ${avatarHtml}
                    </div>
                    <div class="user-info">
                        <div class="username">${player.name || '–ò–≥—Ä–æ–∫'}</div>
                        <div class="user-id">${username}</div>
                    </div>
                    <div class="score">
                        <span class="score-icon">${scoreIcon}</span> ${score.toLocaleString()}
                    </div>
                `;
                
                ratingList.appendChild(card);
            });
        }

        function goBack() {
            tg.HapticFeedback.impactOccurred('light');
            
            if (window.history.length > 1) {
                window.history.back();
            } else {
                tg.close();
            }
        }

        document.addEventListener('DOMContentLoaded', initTelegramApp);
    </script>
</body>
</html>
